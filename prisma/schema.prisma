// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  memberships ProjectMembership[]
  auditLogs   AuditLog[]
}

// Project model
model Project {
  id        String   @id @default(cuid())
  name      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  memberships    ProjectMembership[]
  invitations    Invitation[]
  dashboards     Dashboard[]
  reports        Report[]
  profiles       Profile[]
  events         Event[]
  auditLogs      AuditLog[]
  idHierarchy    IdHierarchy[]
  segments       Segment[]
  eventSchemas   EventSchema[]
  userSchemas    UserSchema[]
  idMappings     IdMapping[]
}

// ProjectMembership model
model ProjectMembership {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

// Invitation model
model Invitation {
  id           String    @id @default(cuid())
  token        String    @unique
  projectId    String
  invitedEmail String
  role         Role
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime  @default(now())
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([projectId])
  @@index([invitedEmail])
}

// Dashboard model
model Dashboard {
  id        String   @id @default(cuid())
  projectId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  project Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  widgets Widget[]
  
  @@index([projectId])
}

// Widget model
model Widget {
  id          String   @id @default(cuid())
  dashboardId String
  type        String
  title       String
  config      Json
  position    Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  
  @@index([dashboardId])
}

// Report model
model Report {
  id        String   @id @default(cuid())
  projectId String
  name      String
  category  String
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([category])
}

// Profile model
model Profile {
  id         String   @id @default(cuid())
  projectId  String
  externalId String
  traits     Json
  identities Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  project    Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events     Event[]
  idMappings IdMapping[]
  
  @@unique([projectId, externalId])
  @@index([projectId])
  @@index([externalId])
}

// IdMapping model - High-performance ID resolution table
model IdMapping {
  id        String    @id @default(cuid())
  projectId String
  idType    String    // e.g., "email", "idfa", "session", "cookie", "device_id"
  idValue   String    // The actual identifier value
  profileId String    // The unified profile ID
  createdAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiration for temporary IDs
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, idType, idValue])
  @@index([profileId])
  @@index([expiresAt])
  @@index([projectId, idType])
}

// Event model
model Event {
  id        String   @id @default(cuid())
  projectId String
  profileId String
  eventName String
  payload   Json
  timestamp DateTime
  createdAt DateTime @default(now())
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([profileId])
  @@index([eventName])
  @@index([timestamp])
}

// AuditLog model
model AuditLog {
  id        String   @id @default(cuid())
  projectId String?
  userId    String
  action    String
  details   Json
  timestamp DateTime @default(now())
  
  project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
  @@index([userId])
  @@index([action])
  @@index([timestamp])
}

// IdHierarchy model
model IdHierarchy {
  id          String   @id @default(cuid())
  projectId   String
  displayName String
  codeName    String
  priority    Int
  isCustom    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, codeName])
  @@index([projectId])
}

// Segment model
model Segment {
  id           String   @id @default(cuid())
  projectId    String
  name         String
  description  String?
  filterConfig Json     // SegmentFilterConfig
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
  @@index([projectId])
}

// EventSchema model
model EventSchema {
  id          String   @id @default(cuid())
  projectId   String
  eventName   String
  displayName String
  icon        String?
  properties  Json     // EventPropertySchema[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, eventName])
  @@index([projectId])
}

// UserSchema model - Computed fields based on properties
model UserSchema {
  id          String   @id @default(cuid())
  projectId   String
  field       String   // The computed field name
  displayName String
  description String?
  schemaType  UserSchemaType // aggregate or formula
  
  // For aggregate type
  aggregateConfig Json?  // AggregateSchemaConfig
  
  // For formula type
  formula     String?
  
  dataType    String   // SchemaDataType: string, number, boolean, date, duration
  format      String?  // e.g., "Human Readable" for duration
  icon        String?
  category    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, field])
  @@index([projectId])
}

// Enum for user schema types
enum UserSchemaType {
  aggregate  // Type 1: Aggregate operations (Count, Sum, Mean, etc.)
  formula    // Type 2: Custom DSL formula
}

// Enum for roles
enum Role {
  owner
  admin
  editor
  viewer
}
